<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Rule PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Rule language="beanshell" name="TRAKK Provisioning Rule" type="JDBCProvision">
  <Description>
    Provisioning rule for the TRAKK JDBC Application.
    Handles Create, Modify (Add/Remove Entitlements), Enable, Disable, and Delete.
    
    Schema Assumptions:
    - users (id, username, firstname, lastname, email, status)
    - capabilities (id, capability, description) -> 'id' is a Foreign Key to users.id
  </Description>
  <Signature returnType="ProvisioningResult">
    <Inputs>
      <Argument name="log">
        <Description>
          The log object associated with the SailPointContext.
        </Description>
      </Argument>
      <Argument name="context">
        <Description>
          A sailpoint.api.SailPointContext object that can be used to query the database if necessary.
        </Description>
      </Argument>
      <Argument name="application">
        <Description>
          The application object that links to this rule.
        </Description>
      </Argument>
      <Argument name="schema">
        <Description>
          The AppSchema object for the account.
        </Description>
      </Argument>
      <Argument name="connection">
        <Description>
          A connection object to the database.
        </Description>
      </Argument>
      <Argument name="plan">
        <Description>
          The ProvisioningPlan object on its way to the Connector.
        </Description>
      </Argument>
      <Argument name="request">
        <Description>
          The AccountRequest object being processed.
        </Description>
      </Argument>
    </Inputs>
    <Returns>
      <Argument name="result">
        <Description>
          A ProvisioningResult object containing the status (committed, failed, retry) and any errors.
        </Description>
      </Argument>
    </Returns>
  </Signature>
  <Source>
  <![CDATA[
  import java.sql.Connection;
  import java.sql.PreparedStatement;
  import java.sql.ResultSet;
  import java.sql.SQLException;
  import java.sql.Types;
  import java.util.List;
  import sailpoint.object.ProvisioningPlan;
  import sailpoint.object.ProvisioningPlan.AccountRequest;
  import sailpoint.object.ProvisioningPlan.AttributeRequest;
  import sailpoint.object.ProvisioningResult;

  ProvisioningResult result = new ProvisioningResult();

  // Fix: Extract AccountRequest from plan if 'request' is not passed directly
  AccountRequest request = null;
  if (plan != null) {
      List acts = plan.getAccountRequests();
      if (acts != null && !acts.isEmpty()) {
          request = (AccountRequest) acts.get(0);
      }
  }

  if (request == null) {
      return result;
  }

  String nativeIdentity = request.getNativeIdentity();
  String operation = request.getOperation() != null ? request.getOperation().toString() : "";

  System.out.println("DEBUG: TRAKK Provisioning. Op=" + operation + ", ID=" + nativeIdentity);
  System.out.println("DEBUG: TRAKK Rule Start. Connection: " + (connection!=null ? "Valid" : "NULL"));

  try {
      // Resolve ID if not Create
      if (!AccountRequest.Operation.Create.equals(request.getOperation())) {
           PreparedStatement ps = connection.prepareStatement("SELECT id FROM users WHERE username = ?");
           ps.setString(1, nativeIdentity);
           ResultSet rs = ps.executeQuery();
           if (rs.next()) {
               String dbId = rs.getString("id");
               System.out.println("DEBUG: Resolved Username '" + nativeIdentity + "' to DB ID '" + dbId + "'");
               nativeIdentity = dbId;
           } else {
               System.out.println("DEBUG: No user found with username '" + nativeIdentity + "'. Assuming NativeIdentity IS the ID.");
           }
           rs.close();
           ps.close();
      }

      if (AccountRequest.Operation.Create.equals(request.getOperation())) {
          // --- CREATE ACCOUNT ---
          // Generate a new ID if nativeIdentity is missing (or use the one provided by plan)
          // For this example, we assume nativeIdentity is populated or we generate one.
          
          String newId = nativeIdentity;
          if (newId == null) {
               // Generate simple hex ID like the screenshot "1b2c3a4e" (8 chars)
               newId = Long.toHexString(Double.doubleToLongBits(Math.random())).substring(0, 8);
          }
          
          String username = (String) request.getArgument("username"); // IdentityIQ Name
          if (username == null) username = "unknown";
          
          String firstname = (String) request.getArgument("firstname");
          String lastname = (String) request.getArgument("lastname");
          String email = (String) request.getArgument("email");
          
          // Check if user already exists
          boolean userExists = false;
          PreparedStatement checkStmt = connection.prepareStatement("SELECT count(*) FROM users WHERE id = ?");
          checkStmt.setString(1, newId);
          ResultSet rs = checkStmt.executeQuery();
          if (rs.next() && rs.getInt(1) > 0) {
              userExists = true;
              System.out.println("DEBUG: User " + newId + " already exists. Skipping INSERT.");
          }
          rs.close();
          checkStmt.close();
          
          if (!userExists) {
              PreparedStatement stmt = connection.prepareStatement(
                  "INSERT INTO users (id, username, firstname, lastname, email) VALUES (?, ?, ?, ?, ?)"
              );
              
              stmt.setString(1, newId);
              stmt.setString(2, username);
              stmt.setString(3, firstname);
              stmt.setString(4, lastname);
              stmt.setString(5, email);
              // stmt.setString(6, "Active"); // Schema does not have status column
              
              int rows = stmt.executeUpdate();
              System.out.println("DEBUG: Create User Rows Affected: " + rows);
              stmt.close();
          }
          
          // If there are attribute requests (initial entitlements) in the create plan
          if (request.getAttributeRequests() != null) {
              for (AttributeRequest attr : request.getAttributeRequests()) {
                  if ("capability".equals(attr.getName())) {
                      Object val = attr.getValue();
                       if (val instanceof List) {
                           for (String v : (List) val) {
                               if (v != null) {
                                   boolean capExists = false;
                                   PreparedStatement capCheck = connection.prepareStatement("SELECT count(*) FROM capabilities WHERE id=? AND capability=?");
                                   capCheck.setString(1, newId);
                                   capCheck.setString(2, v);
                                   ResultSet rsc = capCheck.executeQuery();
                                   if (rsc.next() && rsc.getInt(1) > 0) capExists = true;
                                   rsc.close();
                                   capCheck.close();

                                   if (!capExists) {
                                       PreparedStatement stmt2 = connection.prepareStatement(
                                          "INSERT INTO capabilities (id, capability, description) VALUES (?, ?, ?)"
                                       );
                                       stmt2.setString(1, newId);
                                       stmt2.setString(2, v);
                                       stmt2.setString(3, "Added by IIQ");
                                       stmt2.executeUpdate();
                                       stmt2.close();
                                   }
                               }
                           }
                       } else {
                           String v = (String) val;
                           if (v != null) {
                               boolean capExists = false;
                               PreparedStatement capCheck = connection.prepareStatement("SELECT count(*) FROM capabilities WHERE id=? AND capability=?");
                               capCheck.setString(1, newId);
                               capCheck.setString(2, v);
                               ResultSet rsc = capCheck.executeQuery();
                               if (rsc.next() && rsc.getInt(1) > 0) capExists = true;
                               rsc.close();
                               capCheck.close();

                               if (!capExists) {
                                   PreparedStatement stmt2 = connection.prepareStatement(
                                      "INSERT INTO capabilities (id, capability, description) VALUES (?, ?, ?)"
                                   );
                                   stmt2.setString(1, newId);
                                   stmt2.setString(2, v);
                                   stmt2.setString(3, "Added by IIQ");
                                   stmt2.executeUpdate();
                                   stmt2.close();
                               }
                           }
                       }
                  }
              }
          }
          
          result.setStatus(ProvisioningResult.STATUS_COMMITTED);
          
      } else if (AccountRequest.Operation.Modify.equals(request.getOperation())) {
          // --- MODIFY ACCOUNT ---
          
          List attrReqs = request.getAttributeRequests();
          if (attrReqs != null) {
              for (AttributeRequest attr : attrReqs) {
                   String name = attr.getName();
                   String op = attr.getOperation().toString();
                   Object val = attr.getValue();
                   
                        if ("capability".equalsIgnoreCase(name) || "assignedRoles".equalsIgnoreCase(name)) {
                            // Handle Entitlements & Roles
                            System.out.println("DEBUG: Processing capability/role attribute. OP=" + op + ", Val=" + val);
                            
                            if (val instanceof List) {
                                for (String v : (List) val) {
                                    if ("Add".equals(op)) {
                                        if (v != null) {
                                            boolean capExists = false;
                                            PreparedStatement capCheck = connection.prepareStatement("SELECT count(*) FROM capabilities WHERE id=? AND capability=?");
                                            capCheck.setString(1, nativeIdentity);
                                            capCheck.setString(2, v);
                                            ResultSet rsc = capCheck.executeQuery();
                                            if (rsc.next() && rsc.getInt(1) > 0) capExists = true;
                                            rsc.close();
                                            capCheck.close();

                                            if (!capExists) {
                                                 System.out.println("DEBUG: Adding capability: " + v);
                                                 PreparedStatement stmt = connection.prepareStatement(
                                                     "INSERT INTO capabilities (id, capability, description) VALUES (?, ?, ?)"
                                                 );
                                                 stmt.setString(1, nativeIdentity);
                                                 stmt.setString(2, v);
                                                 stmt.setString(3, "Added by IIQ"); 
                                                 int rows = stmt.executeUpdate();
                                                 System.out.println("DEBUG: Add Cap Rows Affected: " + rows);
                                                 stmt.close();
                                            } else {
                                                System.out.println("DEBUG: Capability " + v + " already exists. Skipping Add.");
                                            }
                                        }
                                    } else if ("Remove".equals(op)) {
                                        if (v != null) {
                                             System.out.println("DEBUG: Removing capability: " + v);
                                             PreparedStatement stmt = connection.prepareStatement(
                                                 "DELETE FROM capabilities WHERE id = ? AND capability = ?"
                                             );
                                             stmt.setString(1, nativeIdentity);
                                             stmt.setString(2, v);
                                             int rows = stmt.executeUpdate();
                                             System.out.println("DEBUG: Remove Cap Rows Affected: " + rows);
                                             stmt.close();
                                        }
                                    }
                                }
                            } else {
                                String v = (String) val;
                                if ("Add".equals(op)) {
                                    if (v != null) {
                                         boolean capExists = false;
                                         PreparedStatement capCheck = connection.prepareStatement("SELECT count(*) FROM capabilities WHERE id=? AND capability=?");
                                         capCheck.setString(1, nativeIdentity);
                                         capCheck.setString(2, v);
                                         ResultSet rsc = capCheck.executeQuery();
                                         if (rsc.next() && rsc.getInt(1) > 0) capExists = true;
                                         rsc.close();
                                         capCheck.close();

                                         if (!capExists) {
                                             System.out.println("DEBUG: Adding capability (scalar): " + v);
                                             PreparedStatement stmt = connection.prepareStatement(
                                                 "INSERT INTO capabilities (id, capability, description) VALUES (?, ?, ?)"
                                             );
                                             stmt.setString(1, nativeIdentity);
                                             stmt.setString(2, v);
                                             stmt.setString(3, "Added by IIQ"); 
                                             int rows = stmt.executeUpdate();
                                             System.out.println("DEBUG: Add Cap Scalar Rows Affected: " + rows);
                                             stmt.close();
                                         } else {
                                             System.out.println("DEBUG: Capability " + v + " already exists. Skipping Add.");
                                         }
                                    }
                                } else if ("Remove".equals(op)) {
                                    if (v != null) {
                                         System.out.println("DEBUG: Removing capability (scalar): " + v);
                                         PreparedStatement stmt = connection.prepareStatement(
                                             "DELETE FROM capabilities WHERE id = ? AND capability = ?"
                                         );
                                         stmt.setString(1, nativeIdentity);
                                         stmt.setString(2, v);
                                         int rows = stmt.executeUpdate();
                                         System.out.println("DEBUG: Remove Cap Scalar Rows Affected: " + rows);
                                         stmt.close();
                                    }
                                }
                            }
                        } else {
                        // Handle Scalar Updates (e.g. update email, lastname)
                        // Assuming simplistic single value update
                        if ("IIQDisabled".equals(name)) {
                            // Skip handled by Enable/Disable ops usually, but if attribute-driven:
                            continue;
                        }
                        
                        // Only update known columns
                        if (name.equals("email") || name.equals("firstname") || name.equals("lastname")) {
                             System.out.println("DEBUG: Updating scalar attribute " + name);
                             PreparedStatement stmt = connection.prepareStatement(
                                 "UPDATE users SET " + name + " = ? WHERE id = ?"
                             );
                             stmt.setString(1, (String) val);
                             stmt.setString(2, nativeIdentity);
                             int rows = stmt.executeUpdate();
                             System.out.println("DEBUG: Update " + name + " Rows Affected: " + rows);
                             stmt.close();
                        } else {
                             System.out.println("DEBUG: Ignored unknown attribute: " + name);
                        }
                    }
              }
          }
          result.setStatus(ProvisioningResult.STATUS_COMMITTED);
          
      } else if (AccountRequest.Operation.Enable.equals(request.getOperation())) {
           // PreparedStatement stmt = connection.prepareStatement("UPDATE users SET status = 'Active' WHERE id = ?");
           // stmt.setString(1, nativeIdentity);
           // stmt.executeUpdate();
           // stmt.close();
           log.warn("Enable operation requested but no 'status' column in schema. Skipping.");
           System.out.println("DEBUG: Enable requested (Skipped per schema)");
           result.setStatus(ProvisioningResult.STATUS_COMMITTED);
           
      } else if (AccountRequest.Operation.Disable.equals(request.getOperation())) {
           // PreparedStatement stmt = connection.prepareStatement("UPDATE users SET status = 'Disabled' WHERE id = ?");
           // stmt.setString(1, nativeIdentity);
           // stmt.executeUpdate();
           // stmt.close();
           log.warn("Disable operation requested but no 'status' column in schema. Skipping.");
           System.out.println("DEBUG: Disable requested (Skipped per schema)");
           result.setStatus(ProvisioningResult.STATUS_COMMITTED);
           
      } else if (AccountRequest.Operation.Delete.equals(request.getOperation())) {
           // Delete entitlements first (FK constraint usually requires this)
           System.out.println("DEBUG: Deleting User " + nativeIdentity);
           PreparedStatement stmt = connection.prepareStatement("DELETE FROM capabilities WHERE id = ?");
           stmt.setString(1, nativeIdentity);
           int rows1 = stmt.executeUpdate();
           stmt.close();
           
           // Delete user
           stmt = connection.prepareStatement("DELETE FROM users WHERE id = ?");
           stmt.setString(1, nativeIdentity);
           int rows2 = stmt.executeUpdate();
           stmt.close();
           
           System.out.println("DEBUG: Delete User Rows: Caps=" + rows1 + ", Users=" + rows2);
           result.setStatus(ProvisioningResult.STATUS_COMMITTED);
      }
       
       if (!connection.getAutoCommit()) {
           System.out.println("DEBUG: Committing transaction...");
           connection.commit();
           System.out.println("DEBUG: Transaction committed.");
       } else {
           System.out.println("DEBUG: Connection is AutoCommit, changes applied immediately.");
       }

  } catch (SQLException e) {
      System.out.println("DEBUG: SQL Exception: " + e.getMessage());
      e.printStackTrace(); // Print full stack to stdout
      result.setStatus(ProvisioningResult.STATUS_FAILED);
      result.addError(e);
      log.error("TRAKK Provisioning Error: " + e.getMessage());
  }

  return result;

  ]]>
  </Source>
</Rule>
