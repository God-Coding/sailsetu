<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
  <Workflow name="LookupIdentityByPhone" type="Research" libraries="Identity">
    <Variable input="true" name="phoneNumber">
      <Description>WhatsApp phone number to lookup (e.g., 919063248559)</Description>
    </Variable>
    <Variable output="true" name="found">
      <Description>true if Identity was found, false otherwise</Description>
    </Variable>
    <Variable output="true" name="identityName">
      <Description>The name of the found Identity</Description>
    </Variable>
    <Variable output="true" name="displayName">
      <Description>The display name of the found Identity</Description>
    </Variable>
    <Variable output="true" name="email">
      <Description>Email of the found Identity</Description>
    </Variable>
    <Variable output="true" name="capabilities">
      <Description>JSON array of capabilities (e.g., ["Reviewer", "Admin"])</Description>
    </Variable>

    <Step icon="Start" name="Start" posX="25" posY="10">
      <Transition to="Search By Phone"/>
    </Step>

    <Step name="Search By Phone" posX="150" posY="10">
      <Script>
        <Source>
          <![CDATA[
            import sailpoint.object.*;
            import sailpoint.tools.Util;
            import java.util.*;

            found = false;
            identityName = null;
            displayName = null;
            email = null;
            capabilities = "[]";

            if (phoneNumber != null && phoneNumber.length() > 0) {
                // Normalize phone number (strip + and spaces)
                String normalizedPhone = phoneNumber.replaceAll("[^0-9]", "");
                
                Identity identity = null;

                // Search by 'phone' attribute (Auto-Discovery)
                // Search by 'phone' attribute (Optimized - Attribute IS Searchable)
                try {
                    QueryOptions qo = new QueryOptions();
                    List filters = new ArrayList();
                    
                    // Exact match (digits only)
                    filters.add(Filter.eq("phone", normalizedPhone));
                    
                    // Match with + prefix
                    filters.add(Filter.eq("phone", "+" + normalizedPhone));
                    
                    qo.addFilter(Filter.or(filters));
                    qo.setResultLimit(1);
                    
                    Iterator it = context.search(Identity.class, qo);
                    if (it.hasNext()) {
                        identity = (Identity) it.next();
                    }
                    Util.flushIterator(it);
                } catch (Exception e) {
                    System.out.println("Error searching by attribute: " + e);
                }

                // 3. Process Identity if found
                if (identity != null) {
                    workflow.put("found", "true");
                    workflow.put("identityName", identity.getName());
                    workflow.put("displayName", identity.getDisplayName());
                    workflow.put("email", identity.getEmail());
                    
                    // Build capabilities list (Direct Role Mapping)
                    List caps = new ArrayList();
                    
                    // Aggressively find all roles
                    Set allRoles = new HashSet();
                    
                    // 1. Business Roles (Directly Assigned)
                    List assigned = identity.getAssignedRoles();
                    if (assigned != null) {
                        for (Object r : assigned) {
                            if (r != null) allRoles.add(((Bundle)r).getName());
                        }
                    }
                    
                    // 2. IT/Effective Roles
                    List bundles = identity.getBundles();
                    if (bundles != null) {
                        for (Object r : bundles) {
                            if (r != null) allRoles.add(((Bundle)r).getName());
                        }
                    }
                    
                    // 3. Detected Roles
                    List detected = identity.getDetectedRoles();
                    if (detected != null) {
                        for (Object r : detected) {
                            if (r != null) allRoles.add(((Bundle)r).getName());
                        }
                    }

                    for (String rName : allRoles) {
                        String lowName = rName.toLowerCase();
                        caps.add(lowName);
                        System.out.println("[SailSetu] Found Role for " + identity.getName() + ": " + lowName);
                    }
                    
                    if (caps.size() <= 1) {
                         System.out.println("[SailSetu] No specific roles found for " + identity.getName() + " (Only 'user')");
                    }
                    
                    // Convert to JSON array
                    StringBuilder json = new StringBuilder("[");
                    for (int i = 0; i < caps.size(); i++) {
                        if (i > 0) json.append(",");
                        json.append("\"").append(caps.get(i)).append("\"");
                    }
                    json.append("]");
                    workflow.put("capabilities", json.toString());
                } else {
                    workflow.put("found", "false");
                }
            }
          ]]>
        </Source>
      </Script>
      <Transition to="Stop"/>
    </Step>

    <Step icon="Stop" name="Stop" posX="300" posY="10"/>
  </Workflow>
</sailpoint>
