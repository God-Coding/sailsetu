<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
  <Workflow name="RegisterPhoneMapping" type="Research" libraries="Identity">
    <Variable input="true" name="phoneNumber">
      <Description>WhatsApp phone number to register (e.g., 919063248559)</Description>
    </Variable>
    <Variable input="true" name="identityName">
      <Description>The Identity to map the phone number to</Description>
    </Variable>
    <Variable input="true" name="password">
      <Description>SailPoint Password for verification</Description>
    </Variable>
    <Variable output="true" name="success">
      <Description>true if mapping was successful</Description>
    </Variable>
    <Variable output="true" name="message">
      <Description>Status message</Description>
    </Variable>

    <Step icon="Start" name="Start" posX="25" posY="10">
      <Transition to="Register Mapping"/>
    </Step>

    <Step name="Register Mapping" posX="150" posY="10">
      <Script>
        <Source>
          <![CDATA[
            import sailpoint.object.*;
            import sailpoint.api.ObjectUtil;

            success = false;
            message = "Unknown error";

            // 1. Validate Credentials using HTTP Loopback (like connection-form.tsx)
            // We use standard Java HttpURLConnection in Beanshell
            try {
                String targetUrl = "http://localhost:8080/identityiq/scim/v2/ServiceProviderConfig";
                java.net.URL url = new java.net.URL(targetUrl);
                java.net.HttpURLConnection conn = (java.net.HttpURLConnection) url.openConnection();
                conn.setRequestMethod("GET");
                
                // Construct Basic Auth Header manually
                String auth = identityName + ":" + password;
                String encodedAuth = java.util.Base64.getEncoder().encodeToString(auth.getBytes("UTF-8"));
                conn.setRequestProperty("Authorization", "Basic " + encodedAuth);
                conn.setRequestProperty("Content-Type", "application/scim+json");
                conn.setRequestProperty("Accept", "application/scim+json, application/json");
                
                int status = conn.getResponseCode();
                
                if (status != 200) {
                     workflow.put("success", "false");
                     workflow.put("message", "Invalid Password (HTTP " + status + ")");
                     return;
                }
            } catch (Exception e) {
                 workflow.put("success", "false");
                 workflow.put("message", "Auth Error: " + e.getMessage());
                 return;
            }

            // 2. Fetch Identity (Validated)
            Identity identity = context.getObjectByName(Identity.class, identityName);
            if (identity == null) {
                workflow.put("success", "false");
                workflow.put("message", "Identity not found");
                return;
            }

            // 2. Normalize Phone
            String normalizedPhone = phoneNumber.replaceAll("[^0-9]", "");

            // 3. Set PHONE Attribute
            identity.setAttribute("phone", normalizedPhone);
            if (identity == null) {
                workflow.put("success", "false");
                 workflow.put("message", "Identity not found: " + identityName);
                 return;
            }

            // 3. Set PHONE Attribute
            identity.setAttribute("phone", normalizedPhone);
    
            
            context.saveObject(identity);
            context.commitTransaction();
            
            // Also maintain Custom Object Map for fast lookups (backup)
            String customName = "SailSetuPhoneMappings";
            Custom custom = context.getObjectByName(Custom.class, customName);
            if (custom == null) {
                custom = new Custom();
                custom.setName(customName);
                 custom.setAttributes(new Attributes());
            }
            custom.put(normalizedPhone, identityName);
            context.saveObject(custom);
            context.commitTransaction();
            
            workflow.put("success", "true");
            workflow.put("message", "Identity Verified! Phone " + normalizedPhone + " linked to " + identity.getDisplayName());
          ]]>
        </Source>
      </Script>
      <Transition to="Stop"/>
    </Step>

    <Step icon="Stop" name="Stop" posX="300" posY="10"/>
  </Workflow>
</sailpoint>
